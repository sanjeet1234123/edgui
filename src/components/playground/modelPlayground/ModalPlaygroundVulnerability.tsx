import {
  Accordion,
  Badge,
  Box,
  Group,
  Stack,
  Text,
  Tooltip,
} from '@mantine/core'
import styles from './modalPlayground.module.css'
import type { ModelVulnerability } from '@/types/playgroundType'
import { useGetModelVulnerabilityQuery } from '@/hooks/queries/usePlaygroundQueries'
import { useModelStore } from '@/store/modelStore'

function ModalPlaygroundVulnerability() {
  const { currentModel } = useModelStore()

  const { data: modelVulnerability } = useGetModelVulnerabilityQuery(
    currentModel?.model_name ?? '',
  )
  return (
    <>
      {modelVulnerability &&
        modelVulnerability?.vulnerabilities &&
        modelVulnerability?.vulnerabilities.length > 0 && (
          <Stack>
            <Text fw="600" size="var(--size-base)">
              Model Vulnerabilities
            </Text>

            <Accordion
              variant="contained"
              radius="lg"
              defaultValue="vulnerability-0"
              classNames={{
                control: styles.vulnerabilityControl,
                itemTitle: styles.vulnerabilityTitle,
                label: styles.vulnerabilityLabel,
              }}
            >
              {modelVulnerability?.vulnerabilities.map(
                (vulnerability: ModelVulnerability, index: number) => (
                  <Accordion.Item value={`vulnerability-${index}`} key={index}>
                    <Accordion.Control>
                      <Group
                        gap={0}
                        justify="space-between"
                        style={{ flexWrap: 'nowrap' }}
                        mr="0.5rem"
                        p="4px 0"
                      >
                        <Box style={{ width: '55%', minWidth: 0 }}>
                          <Tooltip
                            multiline
                            w={400}
                            transitionProps={{ duration: 200 }}
                            position="top-start"
                            label={
                              <Stack>
                                <Text>{vulnerability.vulnerability_type}</Text>
                                <Group>
                                  <Text size="var(--size-base)" c="white">
                                    Security Rating:
                                  </Text>
                                  <Badge
                                    size="lg"
                                    color={
                                      vulnerability.security_rating < 2
                                        ? 'red'
                                        : vulnerability.security_rating < 4
                                          ? 'orange'
                                          : vulnerability.security_rating < 6
                                            ? 'yellow'
                                            : vulnerability.security_rating < 8
                                              ? 'green'
                                              : 'gray'
                                    }
                                  >
                                    {vulnerability.security_rating}
                                  </Badge>
                                </Group>
                                <Group>
                                  <Text size="var(--size-base)" c="white">
                                    Status:
                                  </Text>
                                  <Badge
                                    size="lg"
                                    color={
                                      vulnerability.status.toLowerCase() ===
                                      'active threat'
                                        ? 'red'
                                        : 'green'
                                    }
                                  >
                                    {vulnerability.status}
                                  </Badge>
                                </Group>
                                <Text>{vulnerability.description}</Text>
                              </Stack>
                            }
                          >
                            <Text
                              classNames={{ root: styles.vulnerabilityTitle }}
                            >
                              {vulnerability.vulnerability_type}
                            </Text>
                          </Tooltip>
                        </Box>
                        <Group gap="xs">
                          <Badge
                            size="lg"
                            variant="light"
                            color={
                              vulnerability.severity.toLowerCase() ===
                              'critical'
                                ? 'red'
                                : vulnerability.severity.toLowerCase() ===
                                    'high'
                                  ? 'orange'
                                  : vulnerability.severity.toLowerCase() ===
                                      'moderate'
                                    ? 'yellow'
                                    : vulnerability.severity.toLowerCase() ===
                                          'low' ||
                                        vulnerability.severity.toLowerCase() ===
                                          'normal'
                                      ? 'green'
                                      : 'gray'
                            }
                          >
                            {vulnerability.severity}
                          </Badge>
                          <Badge
                            size="lg"
                            variant="light"
                            color={
                              vulnerability.safety_status.toLowerCase() ===
                              'safe'
                                ? 'green'
                                : vulnerability.safety_status.toLowerCase() ===
                                    'unsafe'
                                  ? 'red'
                                  : 'gray'
                            }
                          >
                            {vulnerability.safety_status}
                          </Badge>
                        </Group>
                      </Group>
                    </Accordion.Control>
                    <Accordion.Panel>
                      <Stack gap="xs">
                        <Text classNames={{ root: styles.vulnerabilityText }}>
                          <strong>Impact:</strong> {vulnerability.impact}
                        </Text>
                        <Text classNames={{ root: styles.vulnerabilityText }}>
                          <strong>Mitigation:</strong>{' '}
                          {vulnerability.mitigation}
                        </Text>
                      </Stack>
                    </Accordion.Panel>
                  </Accordion.Item>
                ),
              )}
            </Accordion>
          </Stack>
        )}
    </>
  )
}

export default ModalPlaygroundVulnerability
